version: "3.7"
services:
  traefik:
    image: traefik:chevrotin
    container_name: traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.entrypoints=http"
      - "traefik.http.routers.traefik.rule=Host(${TRAEFIK_HOSTNAMES})"
      - "traefik.http.routers.traefik.middlewares=https-redirect@file"
      - "traefik.http.routers.traefik-secure.entrypoints=https"
      - "traefik.http.routers.traefik-secure.rule=Host(${TRAEFIK_HOSTNAMES})"
      - "traefik.http.routers.traefik-secure.middlewares=traefik-auth"
      - "traefik.http.routers.traefik-secure.tls=true"
      - "traefik.http.routers.traefik-secure.tls.certresolver=http"
      - "traefik.http.routers.traefik-secure.service=api@internal"
      - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_AUTHS}"
    command:
      - "--certificatesresolvers.myresolver.acme.email=${LETSENCRYPT_EMAIL}"
    ports:
      - "80:80"     # The HTTP port
      - "443:443"   # TLS/SSL enable port
    networks:
      - gaming_default
      # - homeautomation_default
      - local
      - media_default
      - monitoring_default
      - webservices_default
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./traefik/traefik.yml:/traefik.yml:ro
      - ./traefik/config.yml:/config.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro # So that Traefik can listen to the Docker events
      - certs:/letsencrypt

  smtp:
    build: ./smtp
    container_name: smtp
    ports:
      - "25:25"
    networks:
      - gaming_default
      # - homeautomation_default
      - local
      - media_default
      - monitoring_default
      - webservices_default
    environment:
      - RELAY_NETWORKS= :10.0.0.0/8:172.16.0.0/12:192.168.0.0/16
      - MAILNAME=${SMTP_MAILNAME}
    restart: unless-stopped
  # mysql:

  # redis:

volumes:
  certs:
networks:
  local:
  gaming_default:
    external: true
  homeautomation_default:
    external: true
  media_default:
    external: true
  monitoring_default:
    external: true
  webservices_default:
    external: true